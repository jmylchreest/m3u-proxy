# Base URL Configuration Test Guide

## Overview

This document provides comprehensive testing instructions for the new base URL configuration feature in M3U Proxy. The base URL configuration ensures that all URLs generated by the system (logos, streams, etc.) use the correct public hostname and scheme.

## Configuration Options

### Default Configuration
```toml
[web]
host = "0.0.0.0"
port = 8080
base_url = "http://localhost:8080"
```

### Production Examples
```toml
# Production with domain name
base_url = "https://m3u-proxy.example.com"

# Production with custom port
base_url = "https://m3u-proxy.example.com:8443"

# Local network access
base_url = "http://192.168.1.100:8080"

# Docker deployment
base_url = "http://my-server.local:8080"

# Kubernetes ingress
base_url = "https://m3u-proxy.k8s.example.com"
```

## Test Scenarios

### Test 1: Logo URL Generation in Data Mapping

#### Before Fix (Incorrect)
```
Database channel: tvg_logo = "/api/logos/c63d556e-7b3c-4a85-accd-214c32663482"
```

#### After Fix (Correct)
```
Database channel: tvg_logo = "http://localhost:8080/api/logos/c63d556e-7b3c-4a85-accd-214c32663482"
```

#### Test Steps
1. **Configure base URL:**
   ```toml
   [web]
   base_url = "http://192.168.1.100:8080"
   ```

2. **Create/update data mapping rule** with logo action:
   - Condition: `tvg_id equals "SkySportsF1.uk"`
   - Action: `set_logo` → Select custom logo

3. **Preview the rule:**
   ```bash
   curl -X GET http://localhost:8080/api/data-mapping/preview
   ```

4. **Verify preview shows full URL:**
   ```json
   {
     "actions_preview": [
       {
         "action_type": "set_logo",
         "target_field": "tvg_logo",
         "current_value": "http://icon-tmdb.me/...",
         "new_value": "http://192.168.1.100:8080/api/logos/c63d556e-7b3c-4a85-accd-214c32663482",
         "will_change": true
       }
     ]
   }
   ```

5. **Apply rules to existing channels:**
   ```bash
   curl -X POST http://localhost:8080/api/data-mapping/remap
   ```

6. **Verify database contains full URLs:**
   ```sql
   SELECT tvg_id, tvg_logo FROM channels WHERE tvg_id = 'SkySportsF1.uk';
   -- Expected: tvg_logo = "http://192.168.1.100:8080/api/logos/c63d556e-7b3c-4a85-accd-214c32663482"
   ```

### Test 2: Logo Asset API Responses

#### Test Steps
1. **Configure custom base URL:**
   ```toml
   [web]
   base_url = "https://m3u-proxy.example.com"
   ```

2. **List logo assets:**
   ```bash
   curl -X GET http://localhost:8080/api/logos
   ```

3. **Verify response contains full URLs:**
   ```json
   {
     "assets": [
       {
         "id": "c63d556e-7b3c-4a85-accd-214c32663482",
         "name": "Sky_Sports_F1_logo_2020",
         "url": "https://m3u-proxy.example.com/api/logos/c63d556e-7b3c-4a85-accd-214c32663482"
       }
     ]
   }
   ```

4. **Search logo assets:**
   ```bash
   curl -X GET "http://localhost:8080/api/logos/search?query=sky"
   ```

5. **Verify search results contain full URLs:**
   ```json
   {
     "assets": [
       {
         "url": "https://m3u-proxy.example.com/api/logos/c63d556e-7b3c-4a85-accd-214c32663482"
       }
     ]
   }
   ```

### Test 3: URL Sanitization

#### Test Various Base URL Formats
```bash
# Test trailing slash removal
base_url = "http://localhost:8080/"
# Expected result: "http://localhost:8080/api/logos/uuid"

# Test multiple trailing slashes
base_url = "http://localhost:8080///"
# Expected result: "http://localhost:8080/api/logos/uuid"

# Test missing scheme
base_url = "localhost:8080"
# Expected result: "http://localhost:8080/api/logos/uuid"

# Test with path
base_url = "https://example.com/m3u-proxy"
# Expected result: "https://example.com/m3u-proxy/api/logos/uuid"
```

#### Verification Script
Create a test to verify URL sanitization:
```rust
#[test]
fn test_logo_url_generation() {
    use crate::utils::generate_logo_url;
    use uuid::Uuid;
    
    let logo_id = Uuid::parse_str("c63d556e-7b3c-4a85-accd-214c32663482").unwrap();
    
    // Test various base URL formats
    assert_eq!(
        generate_logo_url("http://localhost:8080/", logo_id),
        "http://localhost:8080/api/logos/c63d556e-7b3c-4a85-accd-214c32663482"
    );
    
    assert_eq!(
        generate_logo_url("localhost:8080", logo_id),
        "http://localhost:8080/api/logos/c63d556e-7b3c-4a85-accd-214c32663482"
    );
    
    assert_eq!(
        generate_logo_url("https://example.com", logo_id),
        "https://example.com/api/logos/c63d556e-7b3c-4a85-accd-214c32663482"
    );
}
```

### Test 4: Integration with Different Deployment Methods

#### Docker Compose
```yaml
version: '3.8'
services:
  m3u-proxy:
    image: m3u-proxy:latest
    ports:
      - "8080:8080"
    environment:
      - CONFIG_FILE=/app/config/config.toml
    volumes:
      - ./config.toml:/app/config/config.toml
```

**config.toml:**
```toml
[web]
base_url = "http://docker-host:8080"
```

#### Kubernetes with Ingress
```yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: m3u-proxy-config
data:
  config.toml: |
    [web]
    host = "0.0.0.0"
    port = 8080
    base_url = "https://m3u-proxy.k8s.example.com"
```

#### Reverse Proxy (nginx)
```nginx
server {
    listen 443 ssl;
    server_name m3u-proxy.example.com;
    
    location / {
        proxy_pass http://localhost:8080;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}
```

**Application config:**
```toml
[web]
base_url = "https://m3u-proxy.example.com"
```

### Test 5: CLI Override

#### Test Command Line Base URL Override
```bash
# Override via environment variable
export CONFIG_BASE_URL="https://custom.example.com"
./m3u-proxy

# Override via config file modification
sed -i 's|base_url = ".*"|base_url = "https://override.example.com"|' config.toml
./m3u-proxy
```

## Expected Results Summary

### ✅ Successful Test Outcomes

1. **Logo URLs in database** contain full URLs with correct scheme/host
2. **API responses** return full URLs instead of relative paths
3. **Data mapping preview** shows full URLs in action previews
4. **M3U playlist generation** uses full URLs for logo references
5. **Logo picker modal** displays logos using full URLs

### ❌ Common Issues and Solutions

#### Issue: Relative URLs still appearing
**Symptoms:**
```json
{
  "tvg_logo": "/api/logos/uuid"
}
```

**Solution:** Ensure all logo generation code uses the `generate_logo_url()` utility function.

#### Issue: Double slashes in URLs
**Symptoms:**
```
http://example.com//api/logos/uuid
```

**Solution:** The `sanitize_base_url()` function should handle this automatically.

#### Issue: Missing scheme
**Symptoms:**
```
localhost:8080/api/logos/uuid
```

**Solution:** The utility function should prepend `http://` for URLs without scheme.

## Deployment Checklist

### Pre-deployment
- [ ] Update `config.toml` with correct `base_url`
- [ ] Test URL generation with deployment-specific base URL
- [ ] Verify M3U players can access generated logo URLs
- [ ] Test data mapping rule preview shows correct URLs

### Post-deployment
- [ ] Verify existing channels have correct logo URLs after remapping
- [ ] Test new channel ingestion generates correct URLs
- [ ] Confirm logo picker modal loads images correctly
- [ ] Validate API responses contain full URLs

### Monitoring
- [ ] Check server logs for URL generation errors
- [ ] Monitor M3U player behavior with new logo URLs
- [ ] Verify external logo access through proxy/ingress

## Troubleshooting

### Debug URL Generation
```bash
# Check current configuration
curl -X GET http://localhost:8080/api/data-mapping/preview | jq '.rules[0].affected_channels[0].actions_preview'

# Verify logo asset URLs
curl -X GET http://localhost:8080/api/logos | jq '.assets[0].url'

# Test specific logo access
curl -I http://your-base-url/api/logos/c63d556e-7b3c-4a85-accd-214c32663482
```

### Common Configuration Mistakes
1. **Incorrect port in base URL** (doesn't match actual listening port)
2. **Missing HTTPS in production** (breaks secure content requirements)
3. **Internal hostname used instead of public** (clients can't resolve)
4. **Trailing path in base URL** (creates incorrect nested paths)

## Performance Impact

The base URL configuration has minimal performance impact:
- **URL generation:** O(1) string concatenation
- **URL sanitization:** O(n) where n is base URL length (typically < 100 chars)
- **Memory overhead:** Negligible (base URL stored once in config)
- **Network impact:** None (URLs are same length, just different content)

## Security Considerations

- **HTTPS in production:** Always use HTTPS base URLs for production deployments
- **Internal vs external URLs:** Ensure base URL is accessible to all intended clients
- **URL validation:** The system sanitizes URLs but doesn't validate hostname resolution
- **Content security:** Logo URLs should be served over same scheme as main application