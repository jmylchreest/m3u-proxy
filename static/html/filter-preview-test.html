<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Filter Preview Test - M3U Proxy</title>
        <link rel="stylesheet" href="/static/css/main.css" />
        <style>
            .test-container {
                max-width: 800px;
                margin: 2rem auto;
                padding: 1rem;
            }
            .test-section {
                margin-bottom: 2rem;
                padding: 1rem;
                border: 1px solid #ddd;
                border-radius: 8px;
            }
            .test-title {
                font-weight: bold;
                margin-bottom: 1rem;
                color: #333;
            }
            .test-description {
                margin-bottom: 1rem;
                color: #666;
                font-style: italic;
            }
            .test-controls {
                margin-bottom: 1rem;
            }
            .test-controls button {
                margin-right: 0.5rem;
                margin-bottom: 0.5rem;
            }
        </style>
    </head>
    <body>
        <div class="test-container">
            <h1>Filter Preview Test</h1>

            <div class="test-section">
                <div class="test-title">Single Condition Preview</div>
                <div class="test-description">
                    Tests the preview format for a single filter condition with text truncation.
                </div>
                <div class="test-controls">
                    <button onclick="testSingleCondition()" class="btn btn-primary">Test Single Condition</button>
                    <button onclick="testSingleConditionLongText()" class="btn btn-secondary">Test Long Text</button>
                </div>
                <div class="filter-preview-container">
                    <div class="filter-preview-label">Single Condition Preview:</div>
                    <div class="filter-preview" id="singlePreview">
                        Click a test button above
                    </div>
                </div>
            </div>

            <div class="test-section">
                <div class="test-title">Multiple Conditions Preview</div>
                <div class="test-description">
                    Tests the "ANY/ALL x of y conditions" format with proper truncation for multiple conditions.
                </div>
                <div class="test-controls">
                    <button onclick="testMultipleConditionsAND()" class="btn btn-primary">Test AND Conditions</button>
                    <button onclick="testMultipleConditionsOR()" class="btn btn-success">Test OR Conditions</button>
                    <button onclick="testManyConditions()" class="btn btn-warning">Test Many Conditions</button>
                    <button onclick="testLongValues()" class="btn btn-danger">Test Long Values</button>
                </div>
                <div class="filter-preview-container">
                    <div class="filter-preview-label">Multiple Conditions Preview:</div>
                    <div class="filter-preview" id="multiplePreview">
                        Click a test button above
                    </div>
                </div>
            </div>

            <div class="test-section">
                <div class="test-title">Edge Cases</div>
                <div class="test-description">
                    Tests edge cases and responsive behavior.
                </div>
                <div class="test-controls">
                    <button onclick="testEmptyConditions()" class="btn btn-outline-primary">Test Empty</button>
                    <button onclick="testVeryLongConditions()" class="btn btn-outline-warning">Test Very Long</button>
                    <button onclick="testSpecialCharacters()" class="btn btn-outline-info">Test Special Chars</button>
                    <button onclick="simulateMobile()" class="btn btn-outline-success">Simulate Mobile</button>
                </div>
                <div class="filter-preview-container">
                    <div class="filter-preview-label">Edge Cases Preview:</div>
                    <div class="filter-preview" id="edgeCasesPreview">
                        Click a test button above
                    </div>
                </div>
            </div>
        </div>

        <script>
            // Mock the FiltersManager for testing
            class MockFiltersManager {
                constructor() {
                    this.availableFields = [
                        { name: 'channel_name', display_name: 'Channel Name' },
                        { name: 'group_title', display_name: 'Group' },
                        { name: 'tvg_country', display_name: 'Country' },
                        { name: 'tvg_language', display_name: 'Language' }
                    ];
                }

                generateFilterPreview(filterData) {
                    const conditions = filterData.conditions || [];
                    const operator = (filterData.logical_operator || "AND").toLowerCase();
                    const operatorText = operator === "and" ? "ALL" : "ANY";

                    if (conditions.length === 0) {
                        return "No conditions";
                    }

                    // Detect if we're on a mobile device for responsive truncation
                    const isMobile = window.innerWidth <= 480;
                    const singleConditionMaxLength = isMobile ? 50 : 80;

                    if (conditions.length === 1) {
                        const condition = conditions[0];
                        const field = this.availableFields.find(
                            (f) => f.name === condition.field_name,
                        );
                        const fieldName = field
                            ? field.display_name || field.name
                            : condition.field_name;
                        const operatorDisplay = this.formatOperatorDisplay(condition.operator);

                        return `${fieldName} ${operatorDisplay} "${this.truncateTextSmart(condition.value, singleConditionMaxLength)}"`;
                    }

                    // For multiple conditions, show detailed list
                    let preview = `${operatorText} of ${conditions.length} conditions:\n`;
                    let currentLength = preview.length;
                    // Adjust max length based on typical preview window size and device
                    const maxLength = isMobile ? 500 : 800;
                    const maxLineLength = isMobile ? 50 : 80; // Maximum characters per line for comfortable reading

                    for (let i = 0; i < conditions.length; i++) {
                        const condition = conditions[i];
                        const field = this.availableFields.find(
                            (f) => f.name === condition.field_name,
                        );
                        const fieldName = field
                            ? field.display_name || field.name
                            : condition.field_name;
                        const operatorDisplay = this.formatOperatorDisplay(condition.operator);

                        // Calculate dynamic truncation based on remaining space and line length
                        const baseConditionLength = `- ${fieldName} ${operatorDisplay} ""`.length;
                        const availableValueLength = Math.min(
                            maxLineLength - baseConditionLength,
                            Math.max(
                                15, // Minimum value length
                                (maxLength - currentLength) / (conditions.length - i) -
                                    baseConditionLength -
                                    10,
                            ),
                        );

                        const value = this.truncateTextSmart(
                            condition.value,
                            availableValueLength,
                        );
                        const conditionText = `- ${fieldName} ${operatorDisplay} "${value}"`;

                        // Check if adding this condition would exceed the limit
                        if (currentLength + conditionText.length + 1 > maxLength && i > 0) {
                            const remaining = conditions.length - i;
                            preview += `... and ${remaining} more condition${remaining === 1 ? "" : "s"}`;
                            break;
                        }

                        preview += conditionText;
                        currentLength += conditionText.length + 1; // +1 for newline

                        if (i < conditions.length - 1) {
                            preview += "\n";
                        }
                    }

                    return preview;
                }

                truncateTextSmart(text, maxLength) {
                    if (!text || text.length <= maxLength) {
                        return text || "";
                    }

                    // If we need to truncate, try to break at word boundaries
                    const truncated = text.substring(0, maxLength - 3);
                    const lastSpaceIndex = truncated.lastIndexOf(" ");

                    // If there's a space reasonably close to the end, break there
                    if (lastSpaceIndex > maxLength * 0.7) {
                        return truncated.substring(0, lastSpaceIndex) + "...";
                    }

                    return truncated + "...";
                }

                formatOperatorDisplay(operator) {
                    const operatorMap = {
                        matches: "matches pattern",
                        notmatches: "does not match pattern",
                        equals: "equals",
                        not_equals: "does not equal",
                        contains: "contains",
                        not_contains: "does not contain",
                        starts_with: "starts with",
                        ends_with: "ends with",
                    };

                    return operatorMap[operator] || operator.replace(/_/g, " ").toLowerCase();
                }
            }

            const mockManager = new MockFiltersManager();

            // Test functions
            function testSingleCondition() {
                const filterData = {
                    conditions: [
                        {
                            field_name: 'channel_name',
                            operator: 'contains',
                            value: 'sport'
                        }
                    ],
                    logical_operator: 'AND'
                };

                const preview = mockManager.generateFilterPreview(filterData);
                document.getElementById('singlePreview').textContent = preview;
            }

            function testSingleConditionLongText() {
                const filterData = {
                    conditions: [
                        {
                            field_name: 'channel_name',
                            operator: 'contains',
                            value: 'This is a very long channel name that should be truncated properly to fit within the preview window without making it too wide or difficult to read'
                        }
                    ],
                    logical_operator: 'AND'
                };

                const preview = mockManager.generateFilterPreview(filterData);
                document.getElementById('singlePreview').textContent = preview;
            }

            function testMultipleConditionsAND() {
                const filterData = {
                    conditions: [
                        {
                            field_name: 'channel_name',
                            operator: 'contains',
                            value: 'sport'
                        },
                        {
                            field_name: 'group_title',
                            operator: 'equals',
                            value: 'Sports Channels'
                        },
                        {
                            field_name: 'tvg_country',
                            operator: 'not_equals',
                            value: 'UK'
                        }
                    ],
                    logical_operator: 'AND'
                };

                const preview = mockManager.generateFilterPreview(filterData);
                document.getElementById('multiplePreview').textContent = preview;
            }

            function testMultipleConditionsOR() {
                const filterData = {
                    conditions: [
                        {
                            field_name: 'channel_name',
                            operator: 'starts_with',
                            value: 'BBC'
                        },
                        {
                            field_name: 'channel_name',
                            operator: 'starts_with',
                            value: 'ITV'
                        },
                        {
                            field_name: 'group_title',
                            operator: 'contains',
                            value: 'UK'
                        }
                    ],
                    logical_operator: 'OR'
                };

                const preview = mockManager.generateFilterPreview(filterData);
                document.getElementById('multiplePreview').textContent = preview;
            }

            function testManyConditions() {
                const conditions = [];
                for (let i = 1; i <= 12; i++) {
                    conditions.push({
                        field_name: 'channel_name',
                        operator: 'contains',
                        value: `channel${i}`
                    });
                }

                const filterData = {
                    conditions: conditions,
                    logical_operator: 'OR'
                };

                const preview = mockManager.generateFilterPreview(filterData);
                document.getElementById('multiplePreview').textContent = preview;
            }

            function testLongValues() {
                const filterData = {
                    conditions: [
                        {
                            field_name: 'channel_name',
                            operator: 'contains',
                            value: 'This is an extremely long channel name that definitely needs to be truncated'
                        },
                        {
                            field_name: 'group_title',
                            operator: 'equals',
                            value: 'Another very long group title that should also be truncated for better display'
                        },
                        {
                            field_name: 'tvg_language',
                            operator: 'not_contains',
                            value: 'Yet another incredibly long value that tests the truncation algorithm'
                        }
                    ],
                    logical_operator: 'AND'
                };

                const preview = mockManager.generateFilterPreview(filterData);
                document.getElementById('multiplePreview').textContent = preview;
            }

            function testEmptyConditions() {
                const filterData = {
                    conditions: [],
                    logical_operator: 'AND'
                };

                const preview = mockManager.generateFilterPreview(filterData);
                document.getElementById('edgeCasesPreview').textContent = preview;
            }

            function testVeryLongConditions() {
                const conditions = [];
                for (let i = 1; i <= 25; i++) {
                    conditions.push({
                        field_name: 'channel_name',
                        operator: 'contains',
                        value: `Very long channel name number ${i} that should trigger the truncation logic`
                    });
                }

                const filterData = {
                    conditions: conditions,
                    logical_operator: 'AND'
                };

                const preview = mockManager.generateFilterPreview(filterData);
                document.getElementById('edgeCasesPreview').textContent = preview;
            }

            function testSpecialCharacters() {
                const filterData = {
                    conditions: [
                        {
                            field_name: 'channel_name',
                            operator: 'matches',
                            value: '.*[HD].*|.*4K.*|.*UHD.*'
                        },
                        {
                            field_name: 'group_title',
                            operator: 'not_contains',
                            value: 'XXX & Adult (18+) Content'
                        }
                    ],
                    logical_operator: 'OR'
                };

                const preview = mockManager.generateFilterPreview(filterData);
                document.getElementById('edgeCasesPreview').textContent = preview;
            }

            function simulateMobile() {
                // Temporarily change viewport to test mobile behavior
                const originalWidth = window.innerWidth;
                Object.defineProperty(window, 'innerWidth', {
                    writable: true,
                    configurable: true,
                    value: 400,
                });

                testMultipleConditionsAND();
                const preview = document.getElementById('multiplePreview').textContent;
                document.getElementById('edgeCasesPreview').textContent = `Mobile simulation:\n${preview}`;

                // Restore original width
                Object.defineProperty(window, 'innerWidth', {
                    writable: true,
                    configurable: true,
                    value: originalWidth,
                });
            }

            // Initialize preview elements with proper CSS class
            document.addEventListener('DOMContentLoaded', function() {
                ['singlePreview', 'multiplePreview', 'edgeCasesPreview'].forEach(id => {
                    const element = document.getElementById(id);
                    if (element) {
                        element.classList.add('filter-preview-text');
                    }
                });
            });
        </script>
    </body>
</html>
