<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Filters - M3U Proxy</title>
        <link rel="stylesheet" href="/static/css/main.css" />
    </head>
    <body>
        <div id="headerContainer"></div>

        <div class="container">
            <div id="navContainer"></div>

            <div id="alertsContainer"></div>

            <!-- Filters Header -->
            <div class="dashboard-header">
                <h1>üîç Channel Filters</h1>
                <p class="text-muted">
                    Define rules to include or exclude channels from your
                    sources
                </p>
            </div>

            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Channel Filters</h2>
                    <button id="addFilterBtn" class="btn btn-primary">
                        Add Filter
                    </button>
                </div>

                <div
                    id="loadingIndicator"
                    class="text-center"
                    style="display: none"
                >
                    <span class="loading"></span> Loading filters...
                </div>

                <div class="filters-container" id="filtersTableBody">
                    <!-- Filters will be loaded here -->
                </div>
            </div>
        </div>

        <!-- Filter Modal -->
        <div id="filterModal" class="modal">
            <div class="modal-content standard-modal">
                <div class="modal-header">
                    <h3 id="modalTitle" class="modal-title">Add Filter</h3>
                </div>
                <div class="modal-body">
                    <form id="filterForm">
                        <div class="form-group">
                            <label for="filterName" class="form-label"
                                >Filter Name *</label
                            >
                            <input
                                type="text"
                                id="filterName"
                                class="form-control"
                                required
                            />
                            <small class="text-muted"
                                >A descriptive name for this filter</small
                            >
                        </div>

                        <!-- Filter Pattern -->
                        <div class="form-group">
                            <label for="filterPattern" class="form-label"
                                >Filter Pattern *</label
                            >
                            <textarea
                                id="filterPattern"
                                class="form-control"
                                rows="5"
                                spellcheck="false"
                                autocomplete="off"
                                autocorrect="off"
                                autocapitalize="off"
                                placeholder='Enter filter pattern... (e.g., channel_name contains "sport" OR (tvg_id contains "BBC" AND group_title not_contains "adult"))'
                                onchange="filtersManager.validateFilterExpression()"
                                oninput="filtersManager.debouncedValidateFilterExpression()"
                            ></textarea>
                            <div id="filterExpressionValidation" class="mt-2"></div>
                            <small class="text-muted">
                                Use natural language patterns with operators
                                like <code>contains</code>, <code>equals</code>,
                                <code>matches</code>, <code>starts_with</code>,
                                <code>ends_with</code>. Add <code>not</code> or
                                <code>case_sensitive</code> before operators as
                                needed. Use <code>AND</code>/<code>OR</code> for logic.
                                <a
                                    href="#"
                                    onclick="filtersManager.showExamplesModal()"
                                    >View examples</a
                                >
                            </small>
                        </div>

                        <!-- Enhanced Validation Feedback -->
                        <div
                            id="patternValidation"
                            class="pattern-validation"
                            style="display: none"
                        >
                            <div class="validation-icons">
                                <div
                                    id="syntaxIcon"
                                    class="validation-icon"
                                    title="Syntax validation"
                                >
                                    Syntax
                                </div>
                                <div
                                    id="fieldsIcon"
                                    class="validation-icon"
                                    title="Field validation"
                                >
                                    Fields
                                </div>
                                <div
                                    id="operatorsIcon"
                                    class="validation-icon"
                                    title="Operator validation"
                                >
                                    Operators
                                </div>
                                <div
                                    id="regexIcon"
                                    class="validation-icon"
                                    title="Regex validation"
                                >
                                    Regex
                                </div>
                            </div>
                            <div
                                id="validationMessages"
                                class="validation-messages"
                            >
                                <!-- Validation messages will appear here -->
                            </div>
                        </div>

                        <div
                            id="validationErrors"
                            class="validation-errors empty"
                        >
                            <!-- Enhanced validation errors will appear here -->
                        </div>

                        <div class="form-group">
                            <label
                                for="startingChannelNumber"
                                class="form-label"
                                >Starting Channel Number</label
                            >
                            <input
                                type="number"
                                id="startingChannelNumber"
                                class="form-control"
                                min="1"
                                value="1"
                            />
                            <small class="text-muted"
                                >Channel numbering starts from this
                                number</small
                            >
                        </div>

                        <div class="form-group">
                            <div class="form-check">
                                <input
                                    type="checkbox"
                                    id="isInverse"
                                    class="form-check-input"
                                />
                                <label for="isInverse" class="form-label"
                                    >Inverse Filter (Exclude matching
                                    channels)</label
                                >
                            </div>
                        </div>

                        <!-- Filter Preview -->
                        <div class="filter-preview-container">
                            <div class="filter-preview-label">
                                Filter Preview:
                            </div>
                            <div class="filter-preview" id="filterPreview">
                                Add conditions above to see the generated filter
                            </div>
                        </div>

                    </form>
                </div>
                <div class="modal-footer">
                    <button id="saveFilter" class="btn btn-primary">
                        Save Filter
                    </button>
                    <button
                        id="cancelFilter"
                        class="btn btn-secondary"
                        onclick="filtersManager.hideFilterModal()"
                    >
                        Cancel
                    </button>
                </div>
            </div>
        </div>

        <!-- Examples Modal -->
        <div id="examplesModal" class="modal">
            <div class="modal-content standard-modal">
                <div class="modal-header">
                    <h3 class="modal-title">Filter Pattern Examples</h3>
                </div>
                <div class="modal-body">
                    <div class="operator-reference mb-4">
                        <h4>Available Operators:</h4>
                        <div class="operator-list">
                            <div class="operator-item">
                                <code>contains</code> - Text contains substring
                                (case insensitive)
                            </div>
                            <div class="operator-item">
                                <code>equals</code> - Exact text match (case
                                insensitive)
                            </div>
                            <div class="operator-item">
                                <code>matches</code> - Regular expression match
                                (case-insensitive by default, executed
                                server-side). See
                                <a
                                    href="https://docs.rs/regex/latest/regex/#syntax"
                                    target="_blank"
                                    >Rust regex syntax</a
                                >
                                for supported patterns.
                            </div>
                            <div class="operator-item">
                                <code>starts_with</code> - Text starts with
                                substring
                            </div>
                            <div class="operator-item">
                                <code>ends_with</code> - Text ends with
                                substring
                            </div>
                        </div>
                        <h5>Modifiers:</h5>
                        <div class="modifier-list">
                            <div class="modifier-item">
                                <code>not</code> - Negates the operator (e.g.,
                                <code>not contains</code>, or use <code>not_contains</code>)
                            </div>
                            <div class="modifier-item">
                                <code>case_sensitive</code> - Makes the match
                                case sensitive
                            </div>
                        </div>
                        <h5>Logic:</h5>
                        <div class="logic-list">
                            <div class="logic-item">
                                <code>AND</code> - All conditions must match
                                (AND logic)
                            </div>
                            <div class="logic-item">
                                <code>OR</code> - Any condition can match (OR
                                logic)
                            </div>
                        </div>
                    </div>
                    <div class="examples-container">
                        <div class="example-item">
                            <div class="example-title">Basic Text Matching</div>
                            <div class="example-pattern">
                                channel_name contains "sport"
                            </div>
                            <div class="example-description">
                                Matches channels with "sport" in the name (case
                                insensitive)
                            </div>
                        </div>

                        <div class="example-item">
                            <div class="example-title">Exact Match</div>
                            <div class="example-pattern">
                                group_title equals "Sports"
                            </div>
                            <div class="example-description">
                                Matches channels where group exactly equals
                                "Sports"
                            </div>
                        </div>

                        <div class="example-item">
                            <div class="example-title">
                                Regex Pattern Matching
                            </div>
                            <div class="example-pattern">
                                channel_name matches "(hd|4k|uhd)"
                            </div>
                            <div class="example-description">
                                Matches channels using regular expressions
                                (case-insensitive by default). See
                                <a
                                    href="https://docs.rs/regex/latest/regex/#syntax"
                                    target="_blank"
                                    >Rust regex syntax documentation</a
                                >
                                for all supported patterns.
                            </div>
                        </div>

                        <div class="example-item">
                            <div class="example-title">
                                Multiple NOT Conditions
                            </div>
                            <div class="example-pattern">
                                channel_name not_contains "adult" AND
                                group_title not_contains "xxx"
                            </div>
                            <div class="example-description">
                                Excludes channels containing "adult" or in
                                groups containing "xxx"
                            </div>
                        </div>

                        <div class="example-item">
                            <div class="example-title">
                                Case Sensitive Matching
                            </div>
                            <div class="example-pattern">
                                channel_name case_sensitive contains "BBC"
                            </div>
                            <div class="example-description">
                                Matches "BBC" but not "bbc" (case sensitive)
                            </div>
                        </div>

                        <div class="example-item">
                            <div class="example-title">Negation with NOT</div>
                            <div class="example-pattern">
                                not channel_name contains "test"
                            </div>
                            <div class="example-description">
                                Excludes channels with "test" in the name
                                (modifier before field)
                            </div>
                        </div>

                        <div class="example-item">
                            <div class="example-title">Combined Modifiers</div>
                            <div class="example-pattern">
                                channel_name not case_sensitive equals "TEST
                                CHANNEL"
                            </div>
                            <div class="example-description">
                                Excludes exact matches for "TEST CHANNEL" (case
                                sensitive negation)
                            </div>
                        </div>

                        <div class="example-item">
                            <div class="example-title">
                                Multiple Modifiers (Alternative Order)
                            </div>
                            <div class="example-pattern">
                                not case_sensitive channel_name contains "BBC"
                            </div>
                            <div class="example-description">
                                Excludes channels containing "BBC" with case
                                sensitivity (modifiers before field)
                            </div>
                        </div>

                        <div class="example-item">
                            <div class="example-title">
                                Multiple Conditions with AND
                            </div>
                            <div class="example-pattern">
                                channel_name contains "news" AND group_title
                                equals "International"
                            </div>
                            <div class="example-description">
                                Matches news channels in the International group
                            </div>
                        </div>

                        <div class="example-item">
                            <div class="example-title">
                                Multiple Conditions with OR
                            </div>
                            <div class="example-pattern">
                                group_title contains "sport" OR channel_name
                                contains "football"
                            </div>
                            <div class="example-description">
                                Matches channels in sports groups OR with
                                "football" in name
                            </div>
                        </div>

                        <div class="example-item">
                            <div class="example-title">Position Matching</div>
                            <div class="example-pattern">
                                channel_name starts_with "US" AND channel_name
                                ends_with "HD"
                            </div>
                            <div class="example-description">
                                Matches channels that start with "US" and end
                                with "HD"
                            </div>
                        </div>

                        <div class="example-item">
                            <div class="example-title">Advanced Grouping with Parentheses</div>
                            <div class="example-pattern">
                                channel_name contains "BBC" OR (tvg_id contains "BBC" AND group_title contains "HD")
                            </div>
                            <div class="example-description">
                                Matches channels with "BBC" in name, OR channels that have both "BBC" in TVG ID and "HD" in group
                            </div>
                        </div>

                        <div class="example-item">
                            <div class="example-title">Complex Nested Groups</div>
                            <div class="example-pattern">
                                (channel_name contains "Sport" OR channel_name contains "Football") AND (group_title not_contains "Adult" AND group_title not_contains "XXX")
                            </div>
                            <div class="example-description">
                                Matches sports channels while excluding adult content using nested logical groups
                            </div>
                        </div>

                    </div>
                </div>
                <div class="modal-footer">
                    <button
                        onclick="filtersManager.hideExamplesModal()"
                        class="btn btn-secondary"
                    >
                        Close
                    </button>
                </div>
            </div>
        </div>

        <script src="/static/js/shared-utils.js"></script>
        <script src="/static/js/shared-loader.js"></script>
        <script>
            // Load shared footer with channels modal
            templateLoader
                .loadTemplate("/static/html/shared/footer-with-channels.html")
                .then((html) => {
                    document.body.insertAdjacentHTML("beforeend", html);
                });
        </script>
        <script src="/static/js/filters.js"></script>
    </body>
</html>
